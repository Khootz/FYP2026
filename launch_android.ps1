# ??\"?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
# ???   FYP - Start Backends + Open Android Studio (One-Click Launch)    ???
# ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
#
# Usage: Right-click this file ??? "Run with PowerShell"
#   OR   Open terminal and run: .\launch_android.ps1
#
# This script:
#   1. Starts the Python FastAPI backend (port 8000)
#   2. Starts the Node.js Express backend (port 4000)
#   3. Builds the Vite frontend into dist/
#   4. Syncs web assets into the Android project
#   5. Opens Android Studio so you can run on your phone

$ErrorActionPreference = "Stop"

# ?\"??\"? Paths ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
$RootDir       = Split-Path -Parent $MyInvocation.MyCommand.Path
$RestaurantDir = Join-Path $RootDir "Restaurant"
$BackendDir    = Join-Path $RootDir "FYP-Mobile_App\backend"
$FrontendDir   = Join-Path $RootDir "FYP-Mobile_App"

# ?\"??\"? Detect current Wi-Fi IP ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
$CurrentIP = (Get-NetIPAddress -AddressFamily IPv4 |
    Where-Object { $_.InterfaceAlias -eq 'Wi-Fi' -and $_.IPAddress -ne '127.0.0.1' } |
    Select-Object -First 1).IPAddress

if (-not $CurrentIP) {
    $CurrentIP = "localhost"
}

Write-Host ""
Write-Host "============================================================" -ForegroundColor Cyan
Write-Host "  FYP Android Launch Script" -ForegroundColor Cyan
Write-Host "  Your IP: $CurrentIP" -ForegroundColor Yellow
Write-Host "============================================================" -ForegroundColor Cyan
Write-Host ""

# ?\"??\"? Helper: Check if a port is already in use ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
function Test-PortInUse {
    param([int]$Port)
    $conn = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue |
            Where-Object { $_.State -eq 'Listen' }
    return $null -ne $conn
}

# ?\"??\"? 1. Start FastAPI (Python) ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
if (Test-PortInUse 8000) {
    Write-Host "[1/5] FastAPI already running on :8000  (skipping)" -ForegroundColor Green
} else {
    Write-Host "[1/5] Starting FastAPI backend on :8000 ..." -ForegroundColor Yellow
    Start-Process powershell -ArgumentList @(
        "-NoExit", "-Command",
        "cd '$RestaurantDir'; Write-Host 'FastAPI Backend :8000' -ForegroundColor Magenta; python -m uvicorn api:app --host 0.0.0.0 --port 8000 --reload"
    ) -WindowStyle Normal
    Start-Sleep -Seconds 4
    Write-Host "   FastAPI started" -ForegroundColor Green
}

# ?\"??\"? 2. Start Node.js Backend ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
if (Test-PortInUse 4000) {
    Write-Host "[2/5] Node.js backend already running on :4000  (skipping)" -ForegroundColor Green
} else {
    Write-Host "[2/5] Starting Node.js backend on :4000 ..." -ForegroundColor Yellow
    Start-Process powershell -ArgumentList @(
        "-NoExit", "-Command",
        "cd '$BackendDir'; Write-Host 'Node.js Backend :4000' -ForegroundColor Green; npm run dev"
    ) -WindowStyle Normal
    Start-Sleep -Seconds 3
    Write-Host "   Node.js backend started" -ForegroundColor Green
}

# ?\"??\"? 3. Build frontend ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
Write-Host "[3/5] Building frontend (vite build) ..." -ForegroundColor Yellow
Push-Location $FrontendDir
npm run build 2>$null | Out-Null
if ($LASTEXITCODE -ne 0 -and !(Test-Path "dist\index.html")) {
    Write-Host "   Build had warnings but dist/ was created" -ForegroundColor DarkYellow
}
Write-Host "   Frontend built" -ForegroundColor Green

# ?\"??\"? 4. Capacitor sync ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
Write-Host "[4/5] Syncing to Android (cap sync) ..." -ForegroundColor Yellow
npx cap sync android 2>$null | Out-Null
Write-Host "   Android synced" -ForegroundColor Green
Pop-Location

# ?\"??\"? 5. Open Android Studio ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
Write-Host "[5/5] Opening Android Studio ..." -ForegroundColor Yellow
Push-Location $FrontendDir
npx cap open android 2>$null
Pop-Location
Write-Host "   Android Studio launched" -ForegroundColor Green

# ?\"??\"? Summary ?\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"??\"?
Write-Host ""
Write-Host "============================================================" -ForegroundColor Green
Write-Host "  All services running!" -ForegroundColor Green
Write-Host "============================================================" -ForegroundColor Green
Write-Host ""
Write-Host "  FastAPI:        http://${CurrentIP}:8000" -ForegroundColor Magenta
Write-Host "  Node.js:        http://${CurrentIP}:4000" -ForegroundColor Green
Write-Host "  API Docs:       http://${CurrentIP}:8000/docs" -ForegroundColor Yellow
Write-Host ""
Write-Host "  Android Studio is opening ??\" hit Run (green play button)" -ForegroundColor Cyan
Write-Host "  to deploy to your connected phone." -ForegroundColor Cyan
Write-Host ""
Write-Host "  To stop services: close the PowerShell windows" -ForegroundColor Red
Write-Host "============================================================" -ForegroundColor Green
Write-Host ""
Write-Host "Press any key to close this window ..." -ForegroundColor DarkGray


$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
